# üìå–ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ –º–æ–¥—É–ª—é 5
## üîπ–ó–∞–¥–∞—á–∏:
- –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–º –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Data Vault
- –†–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –≤ –°–£–ë–î Greenplum

### –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
–ù–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞—Ç–∞—Å–µ—Ç –∏ —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/0.png)

–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ:
- –í –¥–∞—Ç–∞—Å–µ—Ç–µ  –ø—Ä–∏—Å—É—Ç—Å–≤—É–µ—Ç (13 –∫–æ–ª–æ–Ω–æ–∫: Ship Mode, Segment, Country, City, State, Postal Code, Region, Category, Sub-Category, Sales, Quantity, Discount, Profit)
- –í –¥–∞—Ç–∞—Å–µ—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –º—ã —É–±—Ä–∞–ª–∏
–í–µ—Å—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–ø–∏—Å–∞–Ω —Ç—É—Ç [—Ç—É—Ç](https://github.com/andrey-osadchiy/data_storage/tree/main/final/files/DataStorage.ipynb)
### –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
–û–∑–Ω–∞–∫–æ–º–∏–≤—à–∏—Å—å —Å –¥–∞–Ω–Ω—ã–º–∏  –º—ã –º–æ–∂–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î.
#### –ë–∏–∑–Ω–µ—Å‚Äë—Å—É—â–Ω–æ—Å—Ç–∏ –∏ –∫–ª—é—á–∏
**–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ–º–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ:**
- –î–æ—Å—Ç–∞–≤–∫–∞: Ship Mode
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ–≥–º–µ–Ω—Ç: Segment
- –ì–µ–æ–≥—Ä–∞—Ñ–∏—è: Country, State, City, Postal Code, Region
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞: Category, Sub-Category
- –§–∞–∫—Ç—ã –ø—Ä–æ–¥–∞–∂–∏: Sales, Quantity, Discount, Profit

**–í—ã–±–æ—Ä —Ö–∞–±–æ–≤ (Hubs):**
- HUB_SHIP_MODE ‚Äî –±–∏–∑–Ω–µ—Å‚Äë–∫–ª—é—á: Ship Mode
- HUB_SEGMENT ‚Äî –±–∏–∑–Ω–µ—Å‚Äë–∫–ª—é—á: Segment
- HUB_LOCATION ‚Äî –±–∏–∑–Ω–µ—Å‚Äë–∫–ª—é—á: –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è Country|State|City|Postal Code|Region
- HUB_PRODUCT_CATEGORY ‚Äî –±–∏–∑–Ω–µ—Å‚Äë–∫–ª—é—á: Category|Sub-Category

**–õ–∏–Ω–∫–∏ (Links):**
- LNK_SALE_CTX ‚Äî —Å–≤—è–∑—å ¬´–∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–¥–∞–∂–∏¬ª: Ship Mode ‚Üî Segment ‚Üî Location ‚Üî Product Category.

–ë–∏–∑–Ω–µ—Å‚Äë—Å–æ—Å—Ç–∞–≤ –∫–ª—é—á–∞ –ª–∏–Ω–∫–∞: —Ö—ç—à –æ—Ç –≤—Å–µ—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –±–∏–∑–Ω–µ—Å‚Äë–∫–ª—é—á–µ–π –∏–∑ —Ö–∞–±–æ–≤.

**–°–∞—Ç–µ–ª–ª–∏—Ç—ã (Satellites):**
- SAT_LOCATION_ATTR (–∫ HUB_LOCATION): —Ö—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä—É–µ–º—ã–µ –Ω–∞—Ç‚Äë–∞—Ç—Ä–∏–±—É—Ç—ã –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ (Country, State, City, Postal Code, Region). –ù—É–∂–µ–Ω –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ –ø–æ–º–µ–Ω—è–µ—Ç—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Postal Code ‚Üî City.
- SAT_PRODUCT_CATEGORY_ATTR (–∫ HUB_PRODUCT_CATEGORY): —Ö—Ä–∞–Ω–∏—Ç Category, Sub-Category.
- SAT_SHIP_MODE_ATTR (–∫ HUB_SHIP_MODE): —Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ Ship Mode (–∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç, —á—Ç–æ–±—ã –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è).
- SAT_SEGMENT_ATTR (–∫ HUB_SEGMENT): —Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—Å—Ç Segment (–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ).
- SAT_SALE_METRICS (–∫ LNK_SALE_CTX): —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ Sales, Quantity, Discount, Profit.

–û–±—â–∞—è —Å—Ö–µ–º–∞ –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π 
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/34.png)

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–î–∞–ª–µ–µ –∑–∞–≥—Ä—É–∑–∏–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ dbeaver.
PS. –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –º—ã –±—ã –≤—ã–≥—Ä—É–∑–∏–ª–∏ –≤ —Å—Ç—ç–¥–∂–∏–Ω–≥–æ–≤—É—é —Å—Ö–µ–º—É, —Ç.–∫. —ç—Ç–æ —É—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Ç–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –±—É–¥–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ç–∞–º –∂–µ –≥–¥–µ –≤–µ—Å—å dds —Å–ª–æ–π
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/2.png)
–ü—Ä–æ–≤–µ—Ä–∏–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/3.png)

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ –∏—Ö –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º –•–∞–±—ã
```sql
-- HUB_SHIP_MODE
CREATE TABLE IF NOT EXISTS student34.hub_ship_mode (
    hub_ship_mode_key  CHAR(32) PRIMARY KEY,
    ship_mode_bk       TEXT NOT NULL,
    load_dts           TIMESTAMP NOT NULL,
    record_source      TEXT NOT NULL
)
DISTRIBUTED BY (hub_ship_mode_key);

-- HUB_SEGMENT
CREATE TABLE IF NOT EXISTS student34.hub_segment (
    hub_segment_key  CHAR(32) PRIMARY KEY,
    segment_bk       TEXT NOT NULL,
    load_dts         TIMESTAMP NOT NULL,
    record_source    TEXT NOT NULL
)
DISTRIBUTED BY (hub_segment_key);

-- HUB_LOCATION
CREATE TABLE IF NOT EXISTS student34.hub_location (
    hub_location_key  CHAR(32) PRIMARY KEY,
    location_bk       TEXT NOT NULL,
    load_dts          TIMESTAMP NOT NULL,
    record_source     TEXT NOT NULL
)
DISTRIBUTED BY (hub_location_key);

-- HUB_PRODUCT_CATEGORY
CREATE TABLE IF NOT EXISTS student34.hub_product_category (
    hub_product_category_key  CHAR(32) PRIMARY KEY,
    product_category_bk       TEXT NOT NULL,
    load_dts                  TIMESTAMP NOT NULL,
    record_source             TEXT NOT NULL
)
DISTRIBUTED BY (hub_product_category_key);
```
–î–∞–ª–µ–µ –Ω–∞–ø–æ–ª–Ω–∏–º –∏—Ö –¥–∞–Ω–Ω—ã–º–∏
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/4.png)

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –ª–∏–Ω–∫
```sql
CREATE TABLE IF NOT EXISTS student34.lnk_sale_ctx (
    lnk_sale_ctx_key          CHAR(32) PRIMARY KEY,
    hub_ship_mode_key         CHAR(32) NOT NULL,
    hub_segment_key           CHAR(32) NOT NULL,
    hub_location_key          CHAR(32) NOT NULL,
    hub_product_category_key  CHAR(32) NOT NULL,
    load_dts                  TIMESTAMP NOT NULL,
    record_source             TEXT NOT NULL
)
DISTRIBUTED BY (lnk_sale_ctx_key);
```

–ó–∞–ø–æ–ª–Ω–∏–º –∏ –µ–≥–æ
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/5.png)

–û—Å—Ç–∞–ª–∏—Å—å —Å–∞—Ç–µ–ª–ª–∏—Ç—ã —Å–æ–∑–¥–∞–¥–∏–º –∏—Ö
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/6.png)

–ò –Ω–∞–ø–æ–ª–Ω–∏–º
```sql
INSERT INTO student34.sat_ship_mode_attr (
    hub_ship_mode_key, hashdiff, ship_mode,
    start_date, end_date, is_current,
    load_dts, record_source
)
SELECT
    md5(upper(trim(ship_mode))) AS hub_ship_mode_key,
    md5(upper(trim(ship_mode))) AS hashdiff,
    ship_mode,
    current_date AS start_date,
    DATE '9999-12-31' AS end_date,
    TRUE AS is_current,
    now() AS load_dts,
    'samplesuperstore_clean' AS record_source
FROM student34.samplesuperstore_clean
WHERE ship_mode IS NOT NULL
GROUP BY ship_mode;


INSERT INTO student34.sat_segment_attr (
    hub_segment_key, hashdiff, segment,
    start_date, end_date, is_current,
    load_dts, record_source
)
SELECT
    md5(upper(trim(segment))) AS hub_segment_key,
    md5(upper(trim(segment))) AS hashdiff,
    segment,
    current_date AS start_date,
    DATE '9999-12-31' AS end_date,
    TRUE AS is_current,
    now() AS load_dts,
    'samplesuperstore_clean' AS record_source
FROM student34.samplesuperstore_clean
WHERE segment IS NOT NULL
GROUP BY segment;


INSERT INTO student34.sat_location_attr (
    hub_location_key, hashdiff,
    country, state, city, postal_code, region,
    start_date, end_date, is_current,
    load_dts, record_source
)
SELECT
    md5(upper(trim(concat_ws('|', country, state, city, postal_code, region)))) AS hub_location_key,
    md5(upper(trim(concat_ws('|', country, state, city, postal_code, region)))) AS hashdiff,
    country, state, city, postal_code, region,
    current_date AS start_date,
    DATE '9999-12-31' AS end_date,
    TRUE AS is_current,
    now() AS load_dts,
    'samplesuperstore_clean' AS record_source
FROM student34.samplesuperstore_clean
GROUP BY country, state, city, postal_code, region;


INSERT INTO student34.sat_product_category_attr (
    hub_product_category_key, hashdiff,
    category, sub_category,
    start_date, end_date, is_current,
    load_dts, record_source
)
SELECT
    md5(upper(trim(concat_ws('|', category, sub_category)))) AS hub_product_category_key,
    md5(upper(trim(concat_ws('|', category, sub_category)))) AS hashdiff,
    category, sub_category,
    current_date AS start_date,
    DATE '9999-12-31' AS end_date,
    TRUE AS is_current,
    now() AS load_dts,
    'samplesuperstore_clean' AS record_source
FROM student34.samplesuperstore_clean
GROUP BY category, sub_category;


INSERT INTO student34.sat_sale_metrics (
    lnk_sale_ctx_key, hashdiff,
    sales, quantity, discount, profit,
    start_date, end_date, is_current,
    load_dts, record_source
)
SELECT
    md5(upper(trim(concat_ws('|',
        md5(upper(trim(ship_mode))),
        md5(upper(trim(segment))),
        md5(upper(trim(concat_ws('|', country, state, city, postal_code, region)))),
        md5(upper(trim(concat_ws('|', category, sub_category))))
    )))) AS lnk_sale_ctx_key,
    md5(upper(trim(concat_ws('|',
        coalesce(to_char("Sales", 'FM9999999990D0000'), 'NULL'),
        coalesce("Quantity"::text, 'NULL'),
        coalesce(to_char("Discount", 'FM999990D0000'), 'NULL'),
        coalesce(to_char("Profit", 'FM9999999990D0000'), 'NULL')
    )))) AS hashdiff,
    "Sales", "Quantity", "Discount", "Profit",
    current_date AS start_date,
    DATE '9999-12-31' AS end_date,
    TRUE AS is_current,
    now() AS load_dts,
    'samplesuperstore_clean' AS record_source
FROM student34.samplesuperstore_clean;
```
### –ù–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —à–∞–≥–µ —Å–æ–∑–¥–∞–¥–∏–º —Ä—è–¥ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
–ü–æ—Å—á–∏—Ç–∞–µ–º –∫–∞–∫–æ–≤–∞ —Å—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å –∏ —Å–∫–∏–¥–∫–∞ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤
```sql
SELECT
    s.segment,
    ROUND(SUM(m.sales), 2) AS total_sales,
    ROUND(SUM(m.profit), 2) AS total_profit,
    ROUND(AVG(m.discount), 3) AS avg_discount,
    ROUND(SUM(m.profit)/NULLIF(SUM(m.sales),0)*100, 2) AS profit_margin_pct
FROM student34.sat_sale_metrics m
JOIN student34.lnk_sale_ctx c
    ON m.lnk_sale_ctx_key = c.lnk_sale_ctx_key
JOIN student34.sat_segment_attr s
    ON c.hub_segment_key = s.hub_segment_key
GROUP BY s.segment
ORDER BY total_profit DESC;
```
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/7.png)

–í—ã–≤–µ–¥–µ–º –¢–æ–ø-10 –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏ –∏ —Å—Ä–µ–¥–Ω–µ–º—É —á–µ–∫—É
```sql
SELECT
    l.city,
    ROUND(SUM(m.sales), 2) AS total_sales,
    ROUND(SUM(m.profit), 2) AS total_profit,
    ROUND(AVG(m.sales / NULLIF(m.quantity, 0)), 2) AS avg_ticket
FROM student34.sat_sale_metrics m
JOIN student34.lnk_sale_ctx c ON m.lnk_sale_ctx_key = c.lnk_sale_ctx_key
JOIN student34.sat_location_attr l ON c.hub_location_key = l.hub_location_key
GROUP BY l.city
ORDER BY total_profit DESC
LIMIT 10;
```
![–°–∫—Ä–∏–Ω—à–æ—Ç](screenshots/8.png)

–í—Å—ë –ø–æ–ª—É—á–∏–ª–æ—Å—å. –í—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å [—Ç—É—Ç](https://github.com/andrey-osadchiy/data_storage/tree/main/final/SQL/sql.sql)
